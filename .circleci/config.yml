version: 2
jobs:
  build:
    docker:
      - image: golang:1.18
    steps:
      - checkout
      - run: go build ./...
  format:
    docker:
      - image: golang:1.18
    steps:
      - checkout
      - run:
          name: Install gofumports
          command: go install mvdan.cc/gofumpt@latest
      - run:
          name: Run gofumports on all non-generated files
          command: grep -L -R "^\/\/ Code generated .* DO NOT EDIT\.$" --exclude-dir=.git --exclude-dir=vendor --include="*.go" | xargs -n 1 gofumpt -w
      - run:
          name: Check for any changes
          command: git diff --exit-code
  vendor:
    docker:
      - image: golang:1.18
    steps:
      - checkout
      - run: go mod verify
      - run: go mod tidy
      - run: git diff --exit-code
  generate:
    docker:
      - image: golang:1.18
    steps:
      - checkout
      - run: make install
      - run: make generate
      - run: go mod tidy
      - run: git diff --exit-code
  test:
    machine:
      image: cimg/go:1.18
    # The CircleCI user's GOPATH
    working_directory: /home/circleci/.go_workspace/src/github.com/johanbrandhorst/certify
    steps:
      - checkout
      - run: go install github.com/onsi/ginkgo/ginkgo
      - run: ginkgo -v -r -coverprofile=coverage.txt -cover --randomizeAllSpecs --randomizeSuites --failOnPending --trace --race --progress --skipPackage=vendor --skipMeasurements
  docker:
    docker:
      - image: docker
    steps:
      - setup_remote_docker
      - checkout
      - run: docker build .
workflows:
  version: 2
  all:
    jobs:
      - build
      - format
      - vendor
      - generate
      - test
      - docker
